pipeline {
  agent any

  environment {
    ACR_NAME = 'kitchen'
    IMAGE_NAME = 'my-kitchen'
    RESOURCE_GROUP = 'aks-prod-rg'
    AKS_CLUSTER = 'aks-prod'
    AZURE_TENANT = '29d626c9-b1cc-4ef2-b927-27f7dcdbf259'
  }

  stages {
    stage('Clone Repository') {
      steps {
        echo 'Cloning the Repository'
        git 'https://github.com/Dcomforter/New-Kitchen.git'
      }
    }

    stage('Build Docker Image') {
      steps {
        echo 'Building the Docker image'
        sh 'docker build -t $IMAGE_NAME .'
      }
    }
    
    stage('Tag and Push to ACR') {
      steps {
        echo 'Logging into Azure and pushing image'
        script {
          def commitHash = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
          def imageTag = "${ACR_NAME}.azurecr.io/${IMAGE_NAME}:${commitHash}"
        
          withCredentials([usernamePassword(credentialsId: 'ACRLogin', passwordVariable: 'AZURE_PASSWORD', usernameVariable: 'AZURE_APP_ID')]) {
            sh """#!/bin/bash
              az login --service-principal -u $AZURE_APP_ID -p $AZURE_PASSWORD --tenant $AZURE_TENANT
              az acr login --name $ACR_NAME
              docker tag $IMAGE_NAME ${imageTag}
              docker push ${imageTag}
            """
          }
    
          // Save the tag for use in the next stage
          env.IMAGE_TAG = commitHash
        }
      }
    }


    stage('Deploy to AKS') {
      steps {
        echo 'Deploying to AKS'
        sh """#!/bin/bash
        az aks get-credentials --resource-group $RESOURCE_GROUP --name $AKS_CLUSTER --overwrite-existing
        kubelogin convert-kubeconfig -l azurecli
        kubectl set image deployment/kitchapp kitch-cont=${ACR_NAME}.azurecr.io/$IMAGE_NAME:$IMAGE_TAG -n kitchen
        """

      }
    }
    
    stage('Remove Old Images') {
      steps {
        echo 'Pruning System to Remove Old Docker image'
        sh 'docker system prune -af'
      }
    }
    
    stage('Rollout Status Check'){
        steps {
            echo 'Checking Rollout Status'
            sh 'kubectl rollout status deployment/kitchapp -n kitchen'
        }
    }
  }
}
